<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>QR Oluştur – Kartvizit Tarzı</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col">

<!-- HEADER -->
<header class="border-b border-slate-800">
  <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
    <h1 class="text-xl font-bold tracking-tight">Kartvizit QR Oluştur</h1>
    <nav class="space-x-2 text-sm">
      <a href="index.html" class="px-3 py-2 rounded-md hover:bg-slate-800">Dashboard</a>
      <a href="create.html" class="px-3 py-2 rounded-md bg-slate-800">QR Oluştur</a>
      <a href="list.html" class="px-3 py-2 rounded-md hover:bg-slate-800">QR Listesi</a>
    </nav>
  </div>
</header>

<!-- MAIN -->
<main class="flex-1 py-10">
  <div class="max-w-6xl mx-auto px-4 grid lg:grid-cols-2 gap-10">

    <!-- SOL TARAF – FORM -->
    <section class="bg-slate-800/60 border border-slate-700 rounded-2xl p-6 space-y-6">

      <h2 class="text-lg font-semibold">Bilgileri Doldur</h2>
      <p class="text-xs text-slate-400">
        Bütün alanlar opsiyoneldir, doldurduğun her şey QR içine
        <span class="font-semibold text-emerald-400">kartvizit formatında</span> yazılacak.
      </p>

      <!-- AD / BAŞLIK -->
      <div class="space-y-1">
        <label class="text-sm text-slate-300">Ad / Başlık</label>
        <input id="inputName"
               class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
               placeholder="Örn: Berkan Akahışa" />
      </div>

      <!-- METİN -->
      <div class="space-y-1">
        <label class="text-sm text-slate-300">Metin</label>
        <textarea id="inputText"
                  class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                  rows="2"
                  placeholder="Kısa açıklama, slogan, adres vb."></textarea>
      </div>

      <!-- URL -->
      <div class="space-y-1">
        <label class="text-sm text-slate-300">Web Sitesi</label>
        <input id="inputUrl"
               class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
               placeholder="https://siteadresin.com" />
      </div>

      <!-- TELEFON -->
      <div class="space-y-1">
        <label class="text-sm text-slate-300">Telefon Numarası</label>
        <input id="inputPhone"
               class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
               placeholder="+90 5XX XXX XX XX" />
      </div>

      <!-- SOSYAL MEDYA -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="space-y-1">
          <label class="text-xs text-slate-300">Instagram</label>
          <input id="inputInsta"
                 class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                 placeholder="kullaniciadi" />
        </div>
        <div class="space-y-1">
          <label class="text-xs text-slate-300">Facebook</label>
          <input id="inputFacebook"
                 class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                 placeholder="profil veya sayfa URL" />
        </div>
        <div class="space-y-1">
          <label class="text-xs text-slate-300">Twitter (X)</label>
          <input id="inputTwitter"
                 class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                 placeholder="@kullaniciadi" />
        </div>
      </div>

      <!-- NOT ALANI -->
      <div class="space-y-1">
        <label class="text-sm text-slate-300">Not</label>
        <textarea id="note"
                  class="w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                  rows="2"
                  placeholder="Ek bilgi, özel not vb."></textarea>
      </div>

      <!-- ÖZELLEŞTİRME -->
      <div class="border-t border-slate-700 pt-4 space-y-4">
        <h3 class="text-sm font-semibold text-slate-200">QR Görünümü</h3>

        <div>
          <label class="text-sm">Boyut: <span id="sizeLabel">256</span> px</label>
          <input id="qrSize" type="range" min="128" max="512" step="32" value="256" class="w-full" />
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm">Ön Plan (Koyu)</label>
            <input id="colorDark" type="color" value="#000000"
                   class="w-full h-10 rounded bg-slate-900 border border-slate-700" />
          </div>
          <div>
            <label class="text-sm">Arka Plan (Açık)</label>
            <input id="colorLight" type="color" value="#ffffff"
                   class="w-full h-10 rounded bg-slate-900 border border-slate-700" />
          </div>
        </div>

        <div>
          <label class="text-sm">Logo Ekle (Opsiyonel)</label>
          <input id="logoInput" type="file" accept="image/*"
                 class="mt-1 text-xs text-slate-300 file:mr-3 file:py-1.5 file:px-3
                        file:rounded-full file:border-0 file:text-xs
                        file:font-medium file:bg-emerald-500 file:text-slate-900
                        hover:file:bg-emerald-400" />
        </div>
      </div>

      <!-- BUTONLAR -->
      <div class="pt-4 flex gap-3">
        <button id="generateBtn"
                class="flex-1 inline-flex justify-center items-center px-4 py-2 rounded-lg bg-emerald-500 text-slate-900 font-semibold hover:bg-emerald-400">
          QR Oluştur
        </button>

        <button id="saveBtn"
                class="flex-1 inline-flex justify-center items-center px-4 py-2 rounded-lg border border-slate-500 text-slate-200 hover:bg-slate-800 disabled:opacity-40"
                disabled>
          Firebase'e Kaydet
        </button>
      </div>

    </section>

    <!-- SAĞ TARAF – ÖNİZLEME -->
    <section class="bg-slate-800/40 border border-slate-700 rounded-2xl p-6 flex flex-col items-center">
      <h2 class="text-lg font-semibold mb-4 self-start">Önizleme</h2>

      <div id="qrcode"
           class="bg-slate-900/80 rounded-xl p-4 flex items-center justify-center min-h-[260px] min-w-[260px]">
        <span class="text-sm text-slate-500 text-center">
          Alanları doldurun ve "QR Oluştur" butonuna basın.
        </span>
      </div>

      <p id="previewText" class="mt-4 text-xs text-slate-400 whitespace-pre-line break-all text-center"></p>
    </section>

  </div>
</main>

<!-- QR KÜTÜPHANESİ -->
<script src="assets/js/qrcode.min.js"></script>

<!-- UYGULAMA KODU -->
<script type="module">
import { uploadQR } from "./assets/js/qr.js";

// INPUT REFERANSLARI
const nameInput     = document.getElementById("inputName");
const textInput     = document.getElementById("inputText");
const urlInput      = document.getElementById("inputUrl");
const phoneInput    = document.getElementById("inputPhone");
const instaInput    = document.getElementById("inputInsta");
const facebookInput = document.getElementById("inputFacebook");
const twitterInput  = document.getElementById("inputTwitter");
const noteInput     = document.getElementById("note");

// ÖZELLEŞTİRME ELEMANLARI
const sizeInput       = document.getElementById("qrSize");
const sizeLabel       = document.getElementById("sizeLabel");
const colorDarkInput  = document.getElementById("colorDark");
const colorLightInput = document.getElementById("colorLight");
const logoInput       = document.getElementById("logoInput");

const generateBtn = document.getElementById("generateBtn");
const saveBtn     = document.getElementById("saveBtn");

const qrContainer = document.getElementById("qrcode");
const previewText = document.getElementById("previewText");

let logoDataURL = null;
let hasLogo = false;

// Boyut label
sizeInput.addEventListener("input", () => {
  sizeLabel.textContent = sizeInput.value;
});

// Logo yükleme
logoInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) {
    logoDataURL = null;
    hasLogo = false;
    return;
  }
  const reader = new FileReader();
  reader.onload = (event) => {
    logoDataURL = event.target.result;
    hasLogo = true;
  };
  reader.readAsDataURL(file);
});

// Kartvizit tarzı metni oluştur
function buildCardText() {
  const lines = [];

  const name  = nameInput.value.trim();
  const text  = textInput.value.trim();
  const url   = urlInput.value.trim();
  const phone = phoneInput.value.trim();
  const insta = instaInput.value.trim();
  const fb    = facebookInput.value.trim();
  const tw    = twitterInput.value.trim();
  const note  = noteInput.value.trim();

  if (name)  lines.push("Ad / Başlık: " + name);
  if (text)  lines.push("Metin: " + text);
  if (url)   lines.push("Web: " + url);
  if (phone) lines.push("Telefon: " + phone);
  if (insta) lines.push("Instagram: https://instagram.com/" + insta);
  if (fb)    lines.push("Facebook: " + fb);
  if (tw)    lines.push("Twitter (X): https://twitter.com/" + tw.replace("@", ""));
  if (note)  lines.push("Not: " + note);

  return lines.join("\n");
}

// QR OLUŞTUR
generateBtn.addEventListener("click", () => {
  const content = buildCardText();

  if (!content) {
    alert("En az bir alan doldurmalısın.");
    return;
  }

  qrContainer.innerHTML = "";
  previewText.textContent = content;

  const size = Number(sizeInput.value);
  const colorDark  = colorDarkInput.value;
  const colorLight = colorLightInput.value;

  const qr = new QRCode(qrContainer, {
    text: content,
    width: size,
    height: size,
    colorDark,
    colorLight,
    correctLevel: QRCode.CorrectLevel.H
  });

  // Logo ekle
  setTimeout(() => {
    if (!hasLogo || !logoDataURL) {
      saveBtn.disabled = false;
      return;
    }
    const canvas = qrContainer.querySelector("canvas");
    if (!canvas) {
      saveBtn.disabled = false;
      return;
    }
    const ctx = canvas.getContext("2d");
    const img = new Image();
    img.src = logoDataURL;
    img.onload = () => {
      const logoSize = size * 0.25;
      const x = (canvas.width - logoSize) / 2;
      const y = (canvas.height - logoSize) / 2;
      ctx.drawImage(img, x, y, logoSize, logoSize);
      saveBtn.disabled = false;
    };
  }, 150);
});

// FIREBASE'E KAYDET
saveBtn.addEventListener("click", async () => {
  const content = previewText.textContent;
  if (!content) {
    alert("Önce QR oluştur.");
    return;
  }

  const data = {
    text: content,
    size: Number(sizeInput.value),
    colorDark: colorDarkInput.value,
    colorLight: colorLightInput.value,
    hasLogo
    // note'u ayrıca Firestore'a kaydetmek istersen
    // firestore.js içinde saveQR'e ek bir alan olarak ekleyebilirsin
  };

  saveBtn.disabled = true;
  saveBtn.textContent = "Kaydediliyor...";

  try {
    await uploadQR(data);
  } catch (err) {
    console.error(err);
    alert("Kaydederken hata oluştu.");
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = "Firebase'e Kaydet";
  }
});
</script>

</body>
</html>
