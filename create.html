<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>QR Oluştur – Kartvizit QR Sistemi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="assets/css/style.css" />
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col">

<header class="border-b border-slate-800">
  <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
    <h1 class="text-xl font-bold">Kartvizit QR Oluştur</h1>
    <nav class="space-x-2 text-sm">
      <a href="index.html" class="px-3 py-2 rounded-md hover:bg-slate-800">Dashboard</a>
      <a href="create.html" class="px-3 py-2 rounded-md bg-slate-800">QR Oluştur</a>
      <a href="list.html" class="px-3 py-2 rounded-md hover:bg-slate-800">QR Listesi</a>
    </nav>
  </div>
</header>

<main class="flex-1 py-10">
  <div class="max-w-6xl mx-auto px-4 grid lg:grid-cols-2 gap-10">

    <!-- FORM -->
    <section class="bg-slate-800/60 border border-slate-700 rounded-2xl p-6 space-y-6">

      <h2 class="text-lg font-semibold">Bilgileri Doldur</h2>

      <div>
        <label class="text-sm">Ad / Başlık</label>
        <input id="inputName" class="input" placeholder="Örn: Berkan Akahisha" />
      </div>

      <div>
        <label class="text-sm">Metin</label>
        <textarea id="inputText" class="input"></textarea>
      </div>

      <div>
        <label class="text-sm">Web Sitesi</label>
        <input id="inputUrl" class="input" placeholder="https://adres.com" />
      </div>

      <div>
        <label class="text-sm">Telefon Numarası</label>
        <input id="inputPhone" class="input" placeholder="+90 5XX XXX XX XX" />
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="text-xs">Instagram</label>
          <input id="inputInsta" class="input" placeholder="kullaniciadi" />
        </div>

        <div>
          <label class="text-xs">Facebook</label>
          <input id="inputFacebook" class="input" placeholder="profil URL" />
        </div>

        <div>
          <label class="text-xs">Twitter</label>
          <input id="inputTwitter" class="input" placeholder="@kullanici" />
        </div>
      </div>

      <div>
        <label class="text-sm">Not</label>
        <textarea id="note" class="input"></textarea>
      </div>

      <!-- QR SETTINGS -->
      <hr class="border-slate-700">

      <div>
        <label>Boyut: <span id="sizeLabel">256</span>px</label>
        <input id="qrSize" type="range" min="128" max="512" value="256" class="w-full">
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label>Ön Plan</label>
          <input id="colorDark" type="color" value="#000000" class="w-full h-10 rounded">
        </div>
        <div>
          <label>Arka Plan</label>
          <input id="colorLight" type="color" value="#ffffff" class="w-full h-10 rounded">
        </div>
      </div>

      <div>
        <label>Logo (opsiyonel)</label>
        <input id="logoInput" type="file" accept="image/*" class="block text-sm">
      </div>

      <div class="pt-4 flex gap-3">
        <button id="generateBtn" class="flex-1 bg-emerald-500 hover:bg-emerald-400 text-black font-semibold py-3 rounded-lg">QR Oluştur</button>
        <button id="saveBtn" disabled class="flex-1 border border-slate-500 text-slate-300 py-3 rounded-lg disabled:opacity-40">Firebase'e Kaydet</button>
      </div>

    </section>

    <!-- PREVIEW -->
    <section class="bg-slate-800/40 border border-slate-700 rounded-2xl p-6">
      <h2 class="text-lg font-semibold mb-4">Önizleme</h2>
      <div id="qrcode" class="bg-slate-900/80 min-h-[260px] min-w-[260px] rounded-lg flex items-center justify-center">
        <span class="text-slate-400 text-sm">Henüz QR oluşturulmadı.</span>
      </div>
      <p id="previewText" class="text-xs text-slate-400 mt-4 break-all"></p>
    </section>

  </div>
</main>

<!-- QR LIB -->
<script src="assets/js/qrcode.min.js"></script>

<script type="module">
import { saveQRRecord } from "./assets/js/firestore.js";
import { storage } from "./assets/js/firebase.js";
import { ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const nameInput=document.getElementById("inputName");
const textInput=document.getElementById("inputText");
const urlInput=document.getElementById("inputUrl");
const phoneInput=document.getElementById("inputPhone");
const instaInput=document.getElementById("inputInsta");
const facebookInput=document.getElementById("inputFacebook");
const twitterInput=document.getElementById("inputTwitter");
const noteInput=document.getElementById("note");

const sizeInput=document.getElementById("qrSize");
const sizeLabel=document.getElementById("sizeLabel");
const colorDarkInput=document.getElementById("colorDark");
const colorLightInput=document.getElementById("colorLight");
const logoInput=document.getElementById("logoInput");

const generateBtn=document.getElementById("generateBtn");
const saveBtn=document.getElementById("saveBtn");

const qrContainer=document.getElementById("qrcode");
const previewText=document.getElementById("previewText");

let logoDataURL=null;
let hasLogo=false;

logoInput.addEventListener("change",(e)=>{
  const file=e.target.files[0];
  if(!file){logoDataURL=null;hasLogo=false;return;}
  const reader=new FileReader();
  reader.onload=(ev)=>{logoDataURL=ev.target.result;hasLogo=true;};
  reader.readAsDataURL(file);
});

sizeInput.addEventListener("input",()=>sizeLabel.textContent=sizeInput.value);

function getFormData(){
  return{
    name:nameInput.value.trim(),
    text:textInput.value.trim(),
    url:urlInput.value.trim(),
    phone:phoneInput.value.trim(),
    instagram:instaInput.value.trim(),
    facebook:facebookInput.value.trim(),
    twitter:twitterInput.value.trim(),
    note:noteInput.value.trim(),
    createdAt:Date.now()
  };
}

function emptyForm(d){
  return !d.name && !d.text && !d.url && !d.phone && !d.instagram && !d.facebook && !d.twitter && !d.note;
}

// QR CREATE
generateBtn.addEventListener("click", async()=>{

  const d=getFormData();
  if(emptyForm(d)){alert("En az bir alan doldurmalısın.");return;}

  const id=await saveQRRecord(d);

  const qrURL=`https://berkanakahisha.github.io/qr-kod-olusturucum/view.html?id=${id}`;

  previewText.textContent=qrURL;

  qrContainer.innerHTML="";

  const size=Number(sizeInput.value);

  setTimeout(()=>{

    new QRCode(qrContainer,{
      text:qrURL,
      width:size,
      height:size,
      colorDark:colorDarkInput.value,
      colorLight:colorLightInput.value,
      correctLevel:QRCode.CorrectLevel.H
    });

    setTimeout(()=>{
      if(hasLogo && logoDataURL){
        const canvas=qrContainer.querySelector("canvas");
        const ctx=canvas.getContext("2d");
        const img=new Image();
        img.src=logoDataURL;

        img.onload=()=>{
          const L=size*0.25;
          ctx.drawImage(img,(canvas.width-L)/2,(canvas.height-L)/2,L,L);
        };
      }
      saveBtn.disabled=false;
    },150);

  },50);

});

// SAVE STORAGE
saveBtn.addEventListener("click",async()=>{
  const canvas=qrContainer.querySelector("canvas");
  if(!canvas){alert("QR yok!");return;}

  const png=canvas.toDataURL("image/png");
  const filename=`qr_${Date.now()}.png`;

  const sRef=ref(storage,"qrimages/"+filename);

  await uploadString(sRef,png,"data_url");
  const url=await getDownloadURL(sRef);

  alert("QR kaydedildi!");
});

</script>

<style>
.input{
 @apply w-full rounded-lg bg-slate-900 border border-slate-700 px-3 py-2 text-sm;
}
</style>

</body>
</html>
